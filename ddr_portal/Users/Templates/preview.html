{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Preview: {{ file.file_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f5f7fa;
            color: #333;
        }
        .breadcrumbs {
            margin-bottom: 15px;
        }
        .breadcrumbs a {
            text-decoration: none;
            color: #007bff;
        }
        .breadcrumbs span {
            color: #555;
        }
        .content-section {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        canvas {
            border: 1px solid #ccc;
            margin-top: 15px;
            max-width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th, td {
            padding: 8px 10px;
            text-align: left;
        }
        .back-btn {
            display: inline-block;
            margin-top: 20px;
            text-decoration: none;
            color: #007bff;
        }
        .message {
            color: red;
        }
    </style>
</head>
<body>
    <!-- ‚úÖ Breadcrumbs -->
    <div class="breadcrumbs">
        <a href="{% url 'role_redirect' %}">Dashboard</a> >
        <span>Preview: {{ file.file_name }}</span>
    </div>

    <!-- ‚úÖ Content Section -->
    <div class="content-section">
        <h2>üëÅ Preview of {{ file.file_name }}</h2>

        {% if message %}
            <p class="message">{{ message }}</p>
        {% endif %}

        <!-- ‚úÖ PDF Preview -->
        {% if preview_type == "pdf" %}
            <canvas id="pdf-canvas"></canvas>
            <script>
                const url = "{% url 'view_pdf' file.id %}";
                const canvas = document.getElementById('pdf-canvas');
                const ctx = canvas.getContext('2d');

                pdfjsLib.getDocument(url).promise.then(pdf => {
                    pdf.getPage(1).then(page => {
                        const viewport = page.getViewport({scale: 1.2});
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        page.render({canvasContext: ctx, viewport: viewport});
                    });
                });
            </script>

        <!-- ‚úÖ Image Preview -->
        {% elif preview_type == "image" %}
            <canvas id="image-canvas"></canvas>
            <script>
               const canvas = document.getElementById('image-canvas');
               const ctx = canvas.getContext('2d');
               const img = new Image();
               img.src = "{% url 'view_image' file.id %}";
               img.onload = () => {
                   canvas.width = img.width;
                   canvas.height = img.height;
                   ctx.drawImage(img, 0, 0);
               };
            </script>

        <!-- ‚úÖ DOCX Preview -->
        {% elif preview_type == "docx" %}
            <canvas id="docx-canvas"></canvas>
            <script>
                const canvas = document.getElementById('docx-canvas');
                const ctx = canvas.getContext('2d');

                const lineHeight = 24;
                const margin = 20;
                const fontSize = 16;
                const fontFamily = "Segoe UI";

                ctx.font = fontSize + "px " + fontFamily;
                ctx.fillStyle = "#000";

                const textLines = `{{ text_content|escapejs }}`.split('\n');
                let y = margin;

                let canvasWidth = 800;
                let canvasHeight = margin*2 + textLines.length * lineHeight;

                const images = {{ images_data|safe }};
                const imageObjects = [];
                let loadedImages = 0;

                images.forEach(src => {
                    const img = new Image();
                    img.src = src;
                    img.onload = () => {
                        imageObjects.push(img);
                        canvasHeight += img.height + 10;
                        loadedImages++;
                        if (loadedImages === images.length) {
                            drawCanvas();
                        }
                    };
                });

                if (images.length === 0) drawCanvas();

                function drawCanvas() {
                    canvas.width = canvasWidth;
                    canvas.height = canvasHeight;
                    ctx.fillStyle = "#000";
                    ctx.font = fontSize + "px " + fontFamily;
                    y = margin;

                    textLines.forEach(line => {
                        ctx.fillText(line, margin, y);
                        y += lineHeight;
                    });

                    imageObjects.forEach(img => {
                        ctx.drawImage(img, margin, y);
                        y += img.height + 10;
                    });
                }
            </script>

        <!-- ‚úÖ CSV / Excel Preview -->
        {% elif headers %}
            <table>
                <thead>
                    <tr>
                        {% for header in headers %}
                            <th>{{ header }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in rows %}
                        <tr>
                            {% for col in row %}
                                <td>{{ col }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

        {% else %}
            <p>No data to preview.</p>
        {% endif %}

      <a href="{% url 'uploaded_files' document_id=file.document.id %}" class="back-btn">‚Üê Back to view file page</a>

    </div>
</body>
</html>
